<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DotNetTest">
    <PropertyGroup>
      <DotNetTestOptions Condition=" '$(DotNetTestOptions)' == '' ">$(DOTNET_TEST_OPTIONS)</DotNetTestOptions>

      <DotNetTestFilterOptions Condition=" $(IsWIndows) ">$(DotNetTestFilterOptions)&amp;Platform!=not-windows</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" $(IsMacOS) ">$(DotNetTestFilterOptions)&amp;Platform!=not-macos</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" $(IsLinux) ">$(DotNetTestFilterOptions)&amp;Platform!=not-linux</DotNetTestFilterOptions>

      <DotNetTestFilterOptions Condition=" $(CI) ">$(DotNetTestFilterOptions)&amp;Agent!=not-ci</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" !$(CI) ">$(DotNetTestFilterOptions)&amp;Agent!=not-local</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" '$(DotNetTestFilterOptions)' != '' ">--filter &quot;$(DotNetTestFilterOptions.Trim('&amp;').Trim())&quot;</DotNetTestFilterOptions>
    </PropertyGroup>

    <ItemGroup>
      <_DotNetTestProjects Include="@(TestProjects)" Condition=" $(IsWindows) OR '%(NetCoreFramework)' != '' ">
        <DotNetTestOptions Condition="  $(IsWindows) ">$(DotNetTestOptions)</DotNetTestOptions>
        <DotNetTestOptions Condition=" !$(IsWindows) "> --framework %(TestProjects.NetCoreFramework) $(DotNetTestOptions.Trim())</DotNetTestOptions>
        <!-- removing traits for now as it causes issues with the current implementation of dotnet test -->
        <!--<DotNetTestOptions Condition=" '$(DotNetTestFilterOptions)' != '' ">$(DotNetTestOptions) $(DotNetTestFilterOptions.Trim())</DotNetTestOptions>-->
        <TestResultsFileName>%(TestProjects.ProjectName).dotnet.xml</TestResultsFileName>
      </_DotNetTestProjects>
    </ItemGroup>

    <Exec
        Command="dotnet test --configuration &quot;$(Configuration)&quot; --no-build %(_DotNetTestProjects.DotNetTestOptions) --logger &quot;trx;LogFileName=%(_DotNetTestProjects.TestResultsFileName)&quot; -- RunConfiguration.ResultsDirectory=&quot;$(TestArtifactsRoot)&quot;"
        WorkingDirectory="%(_DotNetTestProjects.ProjectDir)" />
  </Target>

  <PropertyGroup>
    <TestDependsOn>
      $(BeforeTest);
      DotNetTest;
      $(TestDependsOn);
      $(AfterTest);
    </TestDependsOn>
  </PropertyGroup>

  <Target Name="Testing" DependsOnTargets="$(TestDependsOn)" BeforeTargets="Test" />
</Project>
