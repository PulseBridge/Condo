<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NpmInstallOptions Condition=" '$(NpmInstallOptions)' == '' ">$(NPM_INSTALL_OPTIONS)</NpmInstallOptions>
    <BowerInstallOptions Condition=" '$(BowerInstallOptions)' == '' ">$(BOWER_INSTALL_OPTIONS)</BowerInstallOptions>

    <DotNetRestoreProperties Condition=" '$(DotNetRestoreProperties)' == '' ">$(DOTNET_RESTORE_PROPS)</DotNetRestoreProperties>
  </PropertyGroup>

  <Target Name="DotNetRestore" Condition=" '$(DotNetRestore)' != 'skip' AND '@(DotNetRestorePaths->Count())' != '0' ">
    <PropertyGroup>
      <DotNetRestoreOptions Condition=" '$(DotNetRestoreOptions)' == '' ">$(DOTNET_RESTORE_OPTIONS)</DotNetRestoreOptions>
      <DotNetRestoreOptions Condition=" '$(NuGetConfigPath)' != '' ">$(DotNetRestoreOptions) --configfile &quot;$(NuGetConfigPath)&quot;</DotNetRestoreOptions>

      <DotNetRestoreProperties Condition=" '$(InformationalVersion)' != '' ">$(DotNetRestoreProperties) /p:Version=$(InformationalVersion)</DotNetRestoreProperties>

      <DotNetRestoreArgs>$(DotNetRestoreOptions.Trim()) $(DotNetRestoreProperties.Trim())</DotNetRestoreArgs>
      <DotNetRestoreArgs>$(DotNetRestoreArgs.Trim())</DotNetRestoreArgs>
    </PropertyGroup>

    <ItemGroup>
      <_DotNetRestore Include="@(DotNetRestorePaths)">
        <ProjectName>&quot;%(Filename)%(Extension)&quot;</ProjectName>
        <WorkingDirectory>%(RootDir)%(Directory)</WorkingDirectory>
      </_DotNetRestore>
    </ItemGroup>

    <Exec Command="dotnet restore %(_DotNetRestore.ProjectName) $(DotNetRestoreArgs)"
          WorkingDirectory="%(_DotNetRestore.WorkingDirectory)" />
  </Target>

  <Target Name="NpmInstall" Condition=" '$(NpmInstall)' != 'skip' AND '@(NpmInstallPaths->Count())' != '0' ">
    <Exec Command="npm install $(NpmInstallOptions.Trim())"
          WorkingDirectory="%(NpmInstallPaths.RootDir)%(NpmInstallPaths.Directory)" />
  </Target>

  <Target Name="BowerInstall" Condition=" '$(BowerInstall)' != 'skip' AND '@(BowerInstallPaths->Count())' != '0' ">
    <Exec Command="bower install $(BowerInstallOptions.Trim())"
          WorkingDirectory="%(BowerInstallPaths.RootDir)%(BowerInstallPaths.Directory)" />
  </Target>

  <Target Name="SubmoduleRestore" Condition=" '$(SubmoduleRestore)' != 'skip' AND '@(SubmodulePaths->Count())' != '0' AND $(HasGit) ">
    <RestoreSubmodules RepositoryRoot="$(RepositoryRoot)" />
  </Target>

  <Target Name="CreateOutputPaths">
    <MakeDir Directories="@(ArtifactPaths)" ContinueOnError="true" />
  </Target>

  <PropertyGroup>
    <RestoreDependsOn>
      $(BeforeRestore);
      NpmInstall;
      BowerInstall;
      DotNetRestore;
      $(RestoreDependsOn);
      $(AfterRestore);
    </RestoreDependsOn>

    <PrepareDependsOn>
      $(BeforePrepare);
      CreateOutputPaths;
      SubmoduleRestore;
      Restore;
      $(PrepareDependsOn);
      $(AfterPrepare);
    </PrepareDependsOn>
  </PropertyGroup>

  <Target Name="Restore" DependsOnTargets="$(RestoreDependsOn)" />

  <Target Name="Preparation" DependsOnTargets="$(PrepareDependsOn)" BeforeTargets="Prepare" />
</Project>
