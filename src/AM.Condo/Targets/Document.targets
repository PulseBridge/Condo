<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DocFXPlatformWarning" Condition=" '$(DocFxDocs)' != 'skip' AND '@(DocFxProjects->Count())' != '0' AND !$(IsWindows) ">
    <Warning Text="DocFX is only supported on Windows, currently. Mono is no longer supported as of version 2.6." />
  </Target>

  <Target Name="DocFxDocs" Condition=" '$(DocFxDocs)' != 'skip' AND '@(DocFxProjects->Count())' != '0' ">
    <PropertyGroup>
      <DocFXRoot>$(CondoPath)..$(slash)docfx$(slash)</DocFXRoot>
      <DocFXPath>$(DocFXRoot)docfx.exe</DocFXPath>
      <DocFXCommand>$(DocFXPath)</DocFXCommand>
    </PropertyGroup>

    <PropertyGroup>
      <DocFXArgs Condition=" '$(DocFXArgs)' == '' ">$(DOCFX_ARGS.Trim())</DocFXArgs>
      <DocFXArgs>$(DocFXArgs) --output $(DocsArtifactsRoot)</DocFXArgs>
      <DocFXArgs>$(DocFXArgs.Trim())</DocFXArgs>
      <DocFXVersion Condition=" '$(DocFXVersion)' == '' ">latest</DocFXVersion>
    </PropertyGroup>

    <ItemGroup>
      <_DocFxDocs Include="@(DocFxProjects)">
        <WorkingDirectory>%(RootDir)%(Directory)</WorkingDirectory>
      </_DocFxDocs>
    </ItemGroup>

    <GetRelease Organization="dotnet" Repository="docfx"
                Tag="$(DocFXVersion)" Token="$(GH_TOKEN)"
                Destination="$(DocFXRoot)" />

    <Exec Command="$(DocFXCommand) $(DocFXArgs)" WorkingDirectory="%(_DocFxDocs.WorkingDirectory)" />
  </Target>

  <Target Name="PublishGitHubPages" Condition=" $(CreateRelease) AND $(GitHubPages) AND Exists('$(DocsArtifactsRoot)') ">
    <PublishGitHubPages Source="$(DocsArtifactsRoot)" RepositoryUri="$(RepositoryUri)" />
  </Target>

  <PropertyGroup>
    <AfterDocument>
      $(AfterDocument);
      PublishGitHubPages;
    </AfterDocument>

    <DocumentDependsOn>
      $(BeforeDocument);
      DocFXPlatformWarning;
      DocFxDocs;
      $(DocumentDependsOn);
      $(AfterDocument);
    </DocumentDependsOn>
  </PropertyGroup>

  <Target Name="Documentation" DependsOnTargets="$(DocumentDependsOn)" BeforeTargets="Document" />
</Project>
