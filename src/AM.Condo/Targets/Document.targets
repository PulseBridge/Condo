<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DocFxDocs" Condition=" '$(DocFxDocs)' != 'skip' AND '$(DocFxProjects->Count())' != '0' ">
    <PropertyGroup>
      <DocFXRoot>$(CondoPath)..$(slash)docfx$(slash)</DocFXRoot>
      <DocFXPath>$(DocFXRoot)docfx.exe</DocFXPath>
      <DocFXCommand>$(DocFXPath)</DocFXCommand>
      <HasMono>false</HasMono>
      <DocFXEnabled>false</DocFXEnabled>
    </PropertyGroup>

    <FindCommand Command="mono" Condition=" !$(IsWindows) ">
      <Output TaskParameter="Path" PropertyName="MonoPath" />
      <Output TaskParameter="Exists" PropertyName="HasMono" />
    </FindCommand>

    <PropertyGroup Condition=" $(IsWindows) ">
      <DocFXEnabled>true</DocFXEnabled>
      <DocFXCommand Condition=" $(HasMono) ">mono $(DocFXPath)</DocFXCommand>
      <DocFXArgs Condition=" '$(DocFXArgs)' == '' ">$(DOCFX_ARGS.Trim())</DocFXArgs>
      <DocFXArgs>$(DocFXArgs) --output $(DocsArtifactsRoot)</DocFXArgs>
      <DocFXArgs>$(DocFXArgs.Trim())</DocFXArgs>
    </PropertyGroup>

    <ItemGroup>
      <_DocFxDocs Include="@(DocFxProjects)">
        <WorkingDirectory>%(RootDir)%(Directory)</WorkingDirectory>
      </_DocFxDocs>
    </ItemGroup>

    <!--<Warning Text="Mono must be available on the system to build DocFX projects on non-Windows platforms."
             Condition=" !($(IsWindows) OR $(HasMono)) " />-->

    <GetLatestRelease Organization="dotnet" Repository="docfx" Token="$(GH_TOKEN)"
                      Destination="$(DocFXRoot)" Condition=" $(DocFXEnabled) " />

    <Exec Command="$(DocFXCommand) $(DocFXArgs)"
          WorkingDirectory="%(_DocFxDocs.WorkingDirectory)"
          Condition=" $(DocFxEnabled) " />
  </Target>

  <PropertyGroup>
    <DocumentDependsOn>
      $(BeforeDocument);
      DocFxDocs;
      $(DocumentDependsOn);
      $(AfterDocument);
    </DocumentDependsOn>
  </PropertyGroup>

  <Target Name="Documentation" DependsOnTargets="$(DocumentDependsOn)" BeforeTargets="Document" />
</Project>
