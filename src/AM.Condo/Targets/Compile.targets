<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="DotNetBuild">
    <PropertyGroup>
      <DotNetBuildOptions Condition=" '$(DotNetBuildOptions)' == '' ">$(DOTNET_BUILD_OPTIONS)</DotNetBuildOptions>
      <DotNetBuildOptions Condition=" '$(Configuration)' != '' ">$(DotNetBuildOptions) --configuration &quot;$(Configuration)&quot;</DotNetBuildOptions>
      <DotNetTestBuildOptions Condition=" '$(DotNetTestOptions)' == '' ">$(DotNetBuildOptions)</DotNetTestBuildOptions>

      <DotNetBuildProperties Condition=" '$(DotNetBuildProperties)' == '' ">$(DOTNET_BUILD_PROPS)</DotNetBuildProperties>
      <DotNetBuildProperties>$(DotNetBuildProperties) /p:GenerateAssemblyInfo=false</DotNetBuildProperties>
      <DotNetBuildProperties Condition=" '$(InformationalVersion)' != '' ">$(DotNetBuildProperties) /p:Version=$(InformationalVersion)</DotNetBuildProperties>
      <DotNetBuildProperties>$(DotNetBuildProperties) /clp:NoSummary</DotNetBuildProperties>
      <DotNetTestBuildProperties Condition=" '$(DotNetTestBuildProperties)' == '' ">$(DotNetBuildProperties)</DotNetTestBuildProperties>
      <DotNetBuildProperties>$(DotNetBuildProperties) /p:GenerateDocumentationFile=true</DotNetBuildProperties>
    </PropertyGroup>

    <Exec
        Command="dotnet build &quot;%(SourceProjects.FullPath)&quot; $(DotNetBuildOptions.Trim()) $(DotNetBuildProperties.Trim())"
        WorkingDirectory="$(RepositoryRoot)"
        Condition=" Exists('%(SourceProjects.FullPath)') " />

    <Exec
        Command="dotnet build &quot;%(TestProjects.FullPath)&quot; $(DotNetTestBuildOptions.Trim()) $(DotNetTestBuildProperties.Trim())"
        WorkingDirectory="$(RepositoryRoot)"
        Condition=" Exists('%(TestProjects.FullPath)') " />
  </Target>

  <Target Name="CopyDotNetBuild">
    <ItemGroup>
      <_CopyDotNetBuild Include="%(Projects.ProjectDir)bin$(Slash)**">
        <ProjectName>%(Projects.ProjectName)</ProjectName>
      </_CopyDotNetBuild>
    </ItemGroup>

    <Copy
        SourceFiles="@(_CopyDotNetBuild)"
        DestinationFiles="@(_CopyDotNetBuild->'$(BuildArtifactsRoot)$(Slash)%(ProjectName)$(Slash)%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <PropertyGroup>
    <AfterCompile>
      CopyDotNetBuild;
      $(AfterCompile);
    </AfterCompile>

    <CompileDependsOn>
      $(BeforeCompile);
      DotNetBuild;
      $(CompileDependsOn);
      $(AfterCompile);
    </CompileDependsOn>
  </PropertyGroup>

  <Target Name="Compilation" DependsOnTargets="$(CompileDependsOn)" BeforeTargets="Compile" />
</Project>
