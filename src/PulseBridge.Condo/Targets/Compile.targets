<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <DotNetBuildOptions Condition=" '$(DotNetBuildOptions)' == '' ">$(DOTNET_BUILD_OPTIONS)</DotNetBuildOptions>
  </PropertyGroup>

  <Target Name="DotNetBuild" Condition=" '@(Projects->Count())' != '0' ">
    <Exec
        Command="dotnet build --version-suffix &quot;$(PreReleaseTag)&quot; --configuration &quot;$(Configuration)&quot; $(DotNetBuildOptions) @(Projects->'&quot;%(FullPath)&quot;', ' ')"
        WorkingDirectory="$(RepositoryRoot)" />
  </Target>

  <Target Name="CopyDotNetBuild" AfterTargets="DotNetBuild" Condition=" '@(Projects->Count())' != '0' ">
    <ItemGroup>
      <_CopyDotNetBuild Include="%(Projects.ProjectDir)bin$(Slash)**">
        <ProjectName>%(Projects.ProjectName)</ProjectName>
      </_CopyDotNetBuild>
    </ItemGroup>

    <Copy
        SourceFiles="@(_CopyDotNetBuild)"
        DestinationFiles="@(_CopyDotNetBuild->'$(BuildArtifactsRoot)$(Slash)%(ProjectName)$(Slash)%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <PropertyGroup>
    <CompileDependsOn>
      DotNetBuild;
    </CompileDependsOn>
  </PropertyGroup>

  <Target Name="Compilation" DependsOnTargets="$(CompileDependsOn)" BeforeTargets="Compile" />
</Project>