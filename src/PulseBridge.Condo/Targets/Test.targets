<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DotNetTest">
    <PropertyGroup>
      <DotNetTestOptions Condition=" '$(DotNetTestOptions)' == '' ">$(DOTNET_TEST_OPTIONS)</DotNetTestOptions>

      <DotNetTestPlatformOptions Condition=" $(IsWIndows) ">$(DotNetTestPlatformOptions) -notrait platform=not-windows</DotNetTestPlatformOptions>
      <DotNetTestPlatformOptions Condition=" $(IsMacOS) ">$(DotNetTestPlatformOptions) -notrait platform=not-macos</DotNetTestPlatformOptions>
      <DotNetTestPlatformOptions Condition=" $(IsLinux) ">$(DotNetTestPlatformOptions) -notrait platform=not-linux</DotNetTestPlatformOptions>

      <DotNetTestPlatformOptions Condition=" $(CI) ">$(DotNetTestPlatformOptions) -notrait agent=not-ci</DotNetTestPlatformOptions>
      <DotNetTestPlatformOptions Condition=" !$(CI) ">$(DotNetTestPlatformOptions) -notrait agent=not-local</DotNetTestPlatformOptions>
    </PropertyGroup>

    <ItemGroup>
      <_DotNetTestProjects Include="@(TestProjects)" Condition=" $(IsWindows) Or '%(NetCoreFramework)' != '' ">
        <DotNetTestOptions Condition="  $(IsWindows) ">$(DotNetTestOptions) $(DotNetTestPlatformOptions.Trim())</DotNetTestOptions>
        <DotNetTestOptions Condition=" !$(IsWindows) "> --framework %(TestProjects.NetCoreFramework) $(DotNetTestOptions) $(DotNetTestPlatformOptions.Trim())</DotNetTestOptions>
        <TestResultsPath>$(TestArtifactsRoot)$(slash)%(TestProjects.ProjectName).dotnet.xml</TestResultsPath>
      </_DotNetTestProjects>
    </ItemGroup>

    <Exec
        Command="dotnet test --configuration &quot;$(Configuration)&quot; --no-build %(_DotNetTestProjects.DotNetTestOptions) -xml &quot;%(_DotNetTestProjects.TestResultsPath)&quot;"
        WorkingDirectory="%(_DotNetTestProjects.ProjectDir)"
        Condition=" Exists('%(_DotNetTestProjects.FullPath)') " />
  </Target>

  <PropertyGroup>
    <TestDependsOn>
      $(BeforeTest);
      DotNetTest;
      $(TestDependsOn);
      $(AfterTest);
    </TestDependsOn>
  </PropertyGroup>

  <Target Name="Testing" DependsOnTargets="$(TestDependsOn)" BeforeTargets="Test" />
</Project>
