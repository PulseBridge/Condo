<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="DotNetTest">
    <PropertyGroup>
      <ProjectJsonTestOptions Condition=" '$(ProjectJsonTestOptions)' == '' ">$(DOTNET_PROJECTJSON_TEST_OPTIONS)</ProjectJsonTestOptions>

      <ProjectJsonTestFilterOptions Condition=" $(IsWIndows) ">$(ProjectJsonTestFilterOptions) -notrait platform=not-windows</ProjectJsonTestFilterOptions>
      <ProjectJsonTestFilterOptions Condition=" $(IsMacOS) ">$(ProjectJsonTestFilterOptions) -notrait platform=not-macos</ProjectJsonTestFilterOptions>
      <ProjectJsonTestFilterOptions Condition=" $(IsLinux) ">$(ProjectJsonTestFilterOptions) -notrait platform=not-linux</ProjectJsonTestFilterOptions>

      <ProjectJsonTestFilterOptions Condition=" $(CI) ">$(ProjectJsonTestFilterOptions) -notrait agent=not-ci</ProjectJsonTestFilterOptions>
      <ProjectJsonTestFilterOptions Condition=" !$(CI) ">$(ProjectJsonTestFilterOptions) -notrait agent=not-local</ProjectJsonTestFilterOptions>

      <DotNetTestOptions Condition=" '$(DotNetTestOptions)' == '' ">$(DOTNET_TEST_OPTIONS)</DotNetTestOptions>

      <DotNetTestFilterOptions Condition=" $(IsWIndows) ">$(DotNetTestFilterOptions)&amp;Platform!=not-windows</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" $(IsMacOS) ">$(DotNetTestFilterOptions)&amp;Platform!=not-macos</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" $(IsLinux) ">$(DotNetTestFilterOptions)&amp;Platform=not-linux</DotNetTestFilterOptions>

      <DotNetTestFilterOptions Condition=" $(CI) ">$(DotNetTestFilterOptions)&amp;Agent=not-ci</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" !$(CI) ">$(DotNetTestFilterOptions)&amp;Agent=not-local</DotNetTestFilterOptions>
      <DotNetTestFilterOptions Condition=" '$(DotNetTestFilterOptions)' != '' ">--filter &quote;$(DotNetTestFilterOptions.Trim('&amp;').Trim())&quote;</DotNetTestFilterOptions>
    </PropertyGroup>

    <ItemGroup Condition=" $(IsWindows) Or '%(NetCoreFramework)' != '' ">
      <_ProjectJsonTestProjects Include="@(TestProjects)" Condition=" '%(TestProjects.DotNetType)' == 'ProjectJson' ">
        <DotNetTestOptions Condition="  $(IsWindows) ">$(ProjectJsonTestOptions) $(ProjectJsonTestFilterOptions.Trim())</DotNetTestOptions>
        <DotNetTestOptions Condition=" !$(IsWindows) "> --framework %(TestProjects.NetCoreFramework) $(ProjectJsonTestOptions) $(ProjectJsonTestFilterOptions.Trim())</DotNetTestOptions>
        <TestResultsPath>$(TestArtifactsRoot)$(slash)%(TestProjects.ProjectName).dotnet.xml</TestResultsPath>
      </_ProjectJsonTestProjects>


      <_MSBuildTestProjects Include="@(TestProjects)" Condition=" '%(TestProjects.DotNetType)' == 'MSBuild' ">
        <DotNetTestOptions Condition="  $(IsWindows) ">$(DotNetTestOptions) $(DotNetTestFilterOptions.Trim())</DotNetTestOptions>
        <DotNetTestOptions Condition=" !$(IsWindows) "> --framework %(TestProjects.NetCoreFramework) $(DotNetTestOptions) $(DotNetTestFilterOptions.Trim())</DotNetTestOptions>
        <TestResultsPath>$(TestArtifactsRoot)$(slash)%(TestProjects.ProjectName).dotnet.xml</TestResultsPath>
      </_ProjectJsonTestProjects>
    </ItemGroup>

    <Exec
        Command="dotnet test --configuration &quot;$(Configuration)&quot; --no-build %(_ProjectJsonTestProjects.DotNetTestOptions) -xml &quot;%(_ProjectJsonTestProjects.TestResultsPath)&quot;"
        WorkingDirectory="%(_ProjectJsonTestProjects.ProjectDir)" />

    <Exec
        Command="dotnet test --configuration &quot;$(Configuration)&quot; --no-build %(_MSBuildTestProjects.DotNetTestOptions) --logger:trx;LogFileName=&quot;%(_MSBuildTestProjects.TestResultsPath)&quot;"
        WorkingDirectory="%(_MSBuildTestProjects.ProjectDir)" />
  </Target>


  <PropertyGroup>
    <TestDependsOn>
      $(BeforeTest);
      DotNetTest;
      $(TestDependsOn);
      $(AfterTest);
    </TestDependsOn>
  </PropertyGroup>

  <Target Name="Testing" DependsOnTargets="$(TestDependsOn)" BeforeTargets="Test" />
</Project>
